<!--
  ~ Copyright (c) 2014 Hewlett-Packard Development Company, L.P.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License"); you may
  ~ not use this file except in compliance with the License. You may obtain
  ~ a copy of the License at
  ~
  ~         http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  ~ WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing permissions and limitations
  ~ under the License.
  -->


<div class="container" ng-controller="StoryDetailController">
    <div class="row">
        <div class="col-md-8 col-xs-12">
            <div ng-include
                 src="'/inline/story_detail.html'"
                 ng-hide="showEditForm">
            </div>
            <div ng-include
                 src="'/inline/story_detail_form.html'"
                 ng-show="showEditForm">
            </div>
            <hr/>
            <div ng-include src="'/inline/discussion.html'"></div>
        </div>
        <div class="col-md-4 col-xs-12">
            <h1 class="hidden-xs hidden-sm no-border text-right">
                <!-- Spacer -->
                &nbsp;
            </h1>

            <div ng-include src="'/inline/task_list.html'"></div>
        </div>
    </div>
</div>


<!-- Template for the header and description -->
<script type="text/ng-template" id="/inline/story_detail.html">
    <h1 ng-click="toggleEditMode()" class="editable">
        <span ng-show="story.title">
            {{story.title}}
        </span>
        <em ng-hide="story.title" class="text-muted">
            No title
        </em>
    </h1>
    <p ng-click="toggleEditMode()" class="editable">
        <span ng-show="story.description"
              class="honor-carriage-return">{{story.description}}
        </span>
        <em ng-hide="story.description" class="text-muted">
            No description provided
        </em>
    </p>
</script>


<!-- Template for the header and description -->
<script type="text/ng-template" id="/inline/story_detail_form.html">
    <form name="storyForm">
        <div class="form-group">
            <textarea type="text"
                   class="form-control context-edit h1"
                   ng-model="story.title"
                   required
                   ng-disabled="isUpdating"
                   placeholder="Story Title">
            </textarea>
        </div>
        <div class="form-group">
            <textarea placeholder="Enter a story description here"
                      class="form-control context-edit"
                      rows="3"
                      required
                      ng-disabled="isUpdating"
                      ng-model="story.description">
            </textarea>
        </div>

        <div class="clearfix">
            <div class="pull-right">
                <div class="btn" ng-show="isUpdating">
                    <i class="fa fa-spinner fa-lg fa-spin"></i>
                </div>
                <button type="button"
                        class="btn btn-primary"
                        ng-click="update()"
                        ng-disabled="!storyForm.$valid">
                    Save
                </button>
                <button type="button"
                        class="btn btn-default"
                        ng-click="cancel()">
                    Cancel
                </button>
            </div>
            <button type="button"
                    class="btn btn-link"
                    ng-click="remove()">
                Remove this story
            </button>
        </div>
    </form>
</script>


<!-- Template for the task list -->
<script type="text/ng-template" id="/inline/task_list.html">
    <div ng-controller="StoryTaskListController">
        <button type="button"
                ng-click="showAddTaskForm = !showAddTaskForm"
                ng-show="isLoggedIn"
                class="pull-right btn btn-default btn-sm">
            <i class="fa fa-plus"
               ng-hide="showAddTaskForm"></i>
            <i class="fa fa-minus"
               ng-show="showAddTaskForm"></i>
        </button>

        <h4>Tasks</h4>

        <div class="well" ng-show="showAddTaskForm">
            <form role="form" name="taskForm">
                <div class="form-group row">
                    <label for="title" class="col-sm-2 control-label">
                        Task Title:
                    </label>

                    <div class="col-sm-10">
                        <input id="title"
                               type="text"
                               class="form-control"
                               ng-model="newTask.title"
                               required
                               placeholder="Task Title">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="project" class="col-sm-2 control-label">
                        Task Project:
                    </label>

                    <div class="col-sm-10">
                        <select ng-model="newTask.project_id"
                                id="project"
                                name="project"
                                class="form-control"
                                required
                                ng-options="p.id as p.name for p in projects"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="submit" class="btn btn-default"
                                ng-click="addTask()"
                                ng-disabled="!taskForm.$valid">
                            Add task
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <table class="table table-striped">
            <tbody>
            <tr ng-repeat="task in tasks"
                ng-controller="StoryTaskListItemController">
                <td ng-hide="showTaskEditForm"
                    class="editable"
                    ng-include
                    ng-click="toggleEditForm()"
                    src="'/inline/task_list_item.html'">
                </td>
                <td ng-show="showTaskEditForm"
                    ng-include
                    src="'/inline/task_list_item_form.html'">
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</script>


<!-- Template for the task list -->
<script type="text/ng-template" id="/inline/discussion.html">
    <div ng-controller="StoryDiscussionController">
        <h4>Discussion</h4>

        <div class="discussion">
            <div class="alert alert-warning"
                 ng-show="comments.length == 0">
                The discussion hasn't started yet
            </div>
            <div ng-repeat="event in events"
                 ng-controller="StoryDiscussionItemController"
                 class="discussion-comment">
                <p class="discussion-comment-author">
                    {{author.full_name}}
                </p>

                <p ng-show="event.comment.content"
                   class="honor-carriage-return">{{event.comment.content}}</p>

                <p><em ng-hide="event.comment.content"
                       class="text-muted">
                    The author left a blank comment.
                </em></p>
            </div>

            <form class="discussion-comment-form comment"
                  id="commentForm"
                  name="commentForm"
                  ng-show="isLoggedIn">
                <div class="form-group">
                    <textarea id="comment"
                              placeholder="Enter your comment here"
                              class="form-control"
                              rows="3"
                              required
                              ng-disabled="isSavingComment"
                              ng-shift-enter="addComment()"
                              ng-model="newComment.content">
                    </textarea>
                </div>
                <div class="form-group clearfix">
                    <button type="button"
                            class="btn btn-primary pull-right"
                            ng-click="addComment()"
                            ng-disabled="!commentForm.$valid || isSavingComment">
                        Comment
                    </button>
                </div>
            </form>
        </div>
    </div>
</script>

<!-- Template for an item in the task list -->
<script type="text/ng-template" id="/inline/task_list_item.html">
    <div class="pull-right">
        <task-status-dropdown
                editable="{{isLoggedIn}}"
                on-change="updateStatus(status)"
                status="{{task.status}}"
                />
    </div>
    <p>
        <strong ng-show="project" class="text-primary">
            {{project.name}}
        </strong>
        <em class="text-muted" ng-hide="project">
            Project not found
        </em>
    </p>

    <p>
        {{task.title}}
    </p>
</script>

<!-- Template for an item in the task list -->
<script type="text/ng-template" id="/inline/task_list_item_form.html">
    <form name="taskForm">
        <div class="form-group">
            <select ng-model="task.project_id"
                    class="form-control input-sm"
                    required
                    placeholder="Project"
                    ng-options="p.id as p.name for p in projects"/>
        </div>
        <div class="form-group">
            <textarea
                    ng-model="task.title"
                    required
                    placeholder="Describe the specifics of your task here"
                    class="form-control input-sm">
            </textarea>
        </div>
        <div class="form-group">
            <div class="clearfix">
                <div class="pull-right">
                    <div class="btn" ng-show="isUpdating">
                        <i class="fa fa-spinner fa-lg fa-spin"></i>
                    </div>
                    <button type="button"
                            class="btn btn-primary"
                            ng-click="updateTask()"
                            ng-disabled="!taskForm.$valid">
                        Save
                    </button>
                    <button type="button"
                            class="btn btn-default"
                            ng-click="cancelTask()">
                        Cancel
                    </button>
                </div>
                <button type="button"
                        class="btn btn-link"
                        ng-click="removeTask()">
                    Remove this task
                </button>
            </div>
        </div>
    </form>
</script>