<div class="panel panel-default">
    <div class="panel-heading">
        <button type="button" class="close" aria-hidden="true"
                ng-click="close()">&times;</button>
        <h3 class="panel-title">New Story</h3>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-xs-12">
                <form class="form-horizontal" role="form" name="storyForm">
                    <div class="form-group has-feedback"
                         ng-class="{'has-error': storyForm.name.$invalid,
                                    'has-success': !storyForm.name.$invalid}">
                        <label for="name" class="col-sm-2 control-label">
                            Title:
                        </label>

                        <div class="col-sm-10">
                            <input id="name"
                                   name="name"
                                   focus
                                   type="text"
                                   class="form-control"
                                   ng-model="story.title"
                                   required
                                   maxlength="255"
                                   ng-minlength="5"
                                   placeholder="Story Title">
                            <span class="form-control-feedback"
                                  ng-show="storyForm.name.$invalid">
                                <i class="fa fa-times fa-lg"></i>
                            </span>
                            <span class="form-control-feedback"
                                  ng-show="!storyForm.name.$invalid">
                                <i class="fa fa-check fa-lg"></i>
                            </span>

                            <div class="help-block text-danger"
                                 ng-show="storyForm.name.$invalid">
                                <span ng-show="storyForm.name.$error.required">
                                    A story title is required.
                                </span>
                                <span ng-show="storyForm.name.$error.minlength">
                                    A story title must have at least 5 characters.
                                </span>

                            </div>
                        </div>
                    </div>
                    <div class="form-group" ng-show="preview">
                        <label class="col-sm-2 control-label">
                            Description Preview
                        </label>
                        <div class="col-sm-10">
                            <insert-markdown content="story.description">
                            </insert-markdown>
                        </div>
                    </div>
                    <div class="form-group has-feedback"
                         ng-class="{'has-error': storyForm.description.$invalid,
                                    'has-success': !storyFrom.description.$invalid}">
                        <label for="description"
                               class="col-sm-2 control-label">
                            Description
                        </label>

                        <div class="col-sm-10">
                            <textarea id="description"
                                      name="description"
                                      class="form-control"
                                      ng-model="story.description"
                                      msd-elastic
                                      required
                                      placeholder="A brief story description">
                            </textarea>
                            <span class="form-control-feedback"
                                    ng-show="storyForm.description.$invalid">
                                <i class="fa fa-times fa-lg"></i>
                            </span>
                            <span class="form-control-feedback"
                                  ng-show="!storyForm.description.$invalid">
                                <i class="fa fa-check fa-lg"></i>
                            </span>

                            <div class="help-block text-danger"
                                 ng-show="storyForm.description.$invalid">
                                <span ng-show="storyForm.description.$error.required">
                                    A story description is required.
                                </span>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <form role="form" name="tasksForm">
                    <table class="table table-striped table-outlined">
                        <tbody>
                        <tr ng-repeat="(index, task) in tasks" ng-include
                                src="'/inline/task_row.html'">
                        </tr>
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <button type="button"
                        class="btn btn-default"
                        ng-click="addTask()">
                    &plus;
                    Add another task
                </button>
            </div>
            <div class="col-xs-6 text-right">
                <button type="button"
                        class="btn btn-primary"
                        ng-click="preview = !preview">
                    Preview Description
                </button>
                <button type="button"
                        class="btn btn-primary"
                        ng-click="save()"
                        ng-disabled="!storyForm.$valid || !tasksForm.$valid">
                    Save Changes
                </button>
                <button type="button"
                        ng-click="close()"
                        class="btn btn-default">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template for story metadata -->
<script type="text/ng-template" id="/inline/task_row.html">
    <td 
            ng-class="{'has-error': tasksForm.title.$invalid,'has-success': !tasksForm.title.$invalid}">
        <input type="text"
               class="form-control input-sm"
               ng-model="task.title"
               name="title"
               required
               placeholder="Task Title">
            <div class="has-feedback has-feedback-no-label">
            <span class="help-block text-danger"
                    ng-show="tasksForm.title.$invalid"
                <span ng-show="tasksForm.title.$error.required">
                    A task is required.
                    <i class="fa fa-times fa-lg" ng-show="tasksForm.title.$invalid"></i>
                </span>
            </span>
            <span class= "form-control-feedback">
                <i class="fa fa-check fa-lg" ng-show="!tasksForm.title.$invalid"></i>
            </span>
            </div>
    </td>
    <td class="col-xs-4">
        <div class="has-feedback has-feedback-no-label"
                ng-class="{'has-error': tasksForm.project.$invalid,'has-success': !tasksForm.project.$invalid}">
            <input id="project"
                   name="project"
                   type="text"
                   placeholder="Select a Project"
                   required
                   ng-model="asyncProject"
                   typeahead-wait-ms="200"
                   typeahead-editable="false"
                   typeahead="project as project.name for project
                   in searchProjects($viewValue)"
                   typeahead-loading="loadingProjects"
                   typeahead-input-formatter="formatProjectName($model)"
                   typeahead-on-select="selectNewProject($model, task)"
                   class="form-control input-sm"
                    />
                   <div class="help-block text-danger"
                           ng-show="tasksForm.project.$invalid"
                       <span ng-show="tasksForm.project.$error.required">
                           A project is required.
                       </span>
                   </div>
            <span class="form-control-feedback text-muted
                    form-control-feedback">
                <i class="fa fa-refresh fa-spin" ng-show="loadingProjects"></i>
                <i class="fa fa-search" ng-hide="loadingProjects"></i>
                <i class="fa fa-times fa-lg" ng-show="tasksForm.project.$invalid"></i>
                <i class="fa fa-check fa-lg" ng-show="!tasksForm.project.$invalid"></i>
            </span>

        </div>
    </td>
    <th class="col-xs-1"
        ng-show="tasks.length > 1">
        <button type="button" class="close"
                ng-click="removeTask(task)">
            &times;
        </button>
    </th>
</script>
